<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>‚õΩ CrudeWatch ‚Äì Community Fuel Prices</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
<style>
/* Base Styles */
body {
    font-family:'Source Sans Pro',sans-serif;
    background:#121212;
    color:#eee;
    margin:0;
    padding:0;
    line-height: 1.6;
}
h1 {
    font-family:'Playfair Display',serif;
    color:#ff4e00;
    font-size:2.5em; /* Slightly smaller for mobile safety */
    text-align:center;
    margin:30px 0 10px;
}
h2 {
    color:#ffb570;
    margin-top:30px;
    margin-bottom:15px;
    font-size:1.5em;
    border-bottom:2px solid #ff4e00;
    padding-bottom:5px;
}
.container { 
    width:90%; 
    max-width:800px; 
    margin:0 auto; 
    padding:20px;
}
section { margin-bottom:40px; }

/* Form Elements - Made Touch-Friendly */
input, button {
    padding:15px; /* Larger touch target */
    margin:8px 0;
    border-radius:8px;
    border:none;
    font-size:1rem;
    width: 100%; /* Full width on mobile */
    box-sizing: border-box; /* Ensures padding doesn't break width */
}
input { background:#222; color:#eee; border: 1px solid #333; }
input:focus { outline: 2px solid #ff4e00; background: #333; }

button {
    background:#ff4e00;
    color:#fff;
    cursor:pointer;
    font-weight: 600;
    transition:0.3s;
}
button:hover { background:#ff7044; }

/* Price Card */
.price-card {
    background:linear-gradient(145deg, rgba(255,78,0,0.2), rgba(255,78,0,0.05));
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
    font-size:1.2em;
    text-align:center;
    border: 1px solid rgba(255,78,0,0.3);
}

/* List Items */
ul { list-style:none; padding:0; }
li {
    background:rgba(255,255,255,0.05);
    padding:15px;
    margin-bottom:10px;
    border-radius:10px;
    display:flex;
    flex-direction: column; /* Stack items on mobile */
    gap: 5px;
    border-left: 4px solid #ff4e00;
}
/* Tablet/Desktop Tweaks */
@media (min-width: 600px) {
    li { 
        flex-direction: row; 
        justify-content:space-between; 
        align-items:center; 
    }
}

.badge { 
    padding:4px 8px; 
    border-radius:5px; 
    font-weight:bold; 
    font-size: 0.8em;
    display: inline-block;
    width: fit-content;
}
.pending { background: #ffd700; color:#000; }
.verified { background: #00c853; color:#fff; }

.admin-btn {
    background:#444;
    margin-top: 10px;
}
</style>
</head>
<body>

<div class="container">
<h1>‚õΩ CrudeWatch</h1>

<section>
    <div class="price-card" id="priceSnapshot">Loading prices...</div>
</section>

<section>
<h2>Submit Price ‚õΩ</h2>
<form onsubmit="submitPrice(); return false;">
<input id="station" placeholder="Station Name (e.g. NNPC)" required>
<input id="location" placeholder="Location (e.g. Ikeja)" required>
<input id="price" type="number" placeholder="Price (‚Ç¶)" required>
<button type="submit">Submit Price</button>
</form>
</section>

<section>
<h2>Trusted Access üîê</h2>
<form onsubmit="applyForTrust(); return false;">
<input id="full_name" placeholder="Full Name" required>
<input id="email" placeholder="Email" required>
<input id="phone" placeholder="Phone Number" required>
<input id="address" placeholder="Address" required>
<button type="submit" style="background:#333; border:1px solid #555;">Apply for Access</button>
<p id="apiKeyInfo" style="margin-top:10px; color:#aaa; font-size:0.9em;"></p>
</form>
</section>

<section>
<h2>Update Price üîÑ</h2>
<form onsubmit="updatePriceFunc(); return false;">
<input id="updateId" placeholder="Price ID" required>
<input id="updatePrice" type="number" placeholder="New Price" required>
<input id="apiKey" placeholder="Your API Key" required>
<button type="submit">Update Price</button>
</form>
</section>

<section>
<h2>Admin üõ°Ô∏è</h2>
<button id="adminLoginBtn" class="admin-btn" onclick="adminLogin()">Login as Admin</button>
<button id="adminLogoutBtn" class="admin-btn" onclick="adminLogout()" style="display:none;">Logout</button>
</section>

<section>
<h2>Latest Reports</h2>
<ul id="prices"></ul>
</section>
</div>

<script>
// ---------------------------
// Public Functions
// ---------------------------
async function submitPrice(){
    const station=document.getElementById("station").value;
    const location=document.getElementById("location").value;
    const price=parseFloat(document.getElementById("price").value);
    const res = await fetch("/submit-price",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({station,location,price})
    });
    const data = await res.json();
    if(data.message){
        alert(data.message);
        document.getElementById("station").value="";
        document.getElementById("location").value="";
        document.getElementById("price").value="";
        loadPrices();
    } else alert(data.error);
}

async function applyForTrust(){
    const full_name=document.getElementById("full_name").value;
    const email=document.getElementById("email").value;
    const phone=document.getElementById("phone").value;
    const address=document.getElementById("address").value;
    const res = await fetch("/apply",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({full_name,email,phone,address})
    });
    const data = await res.json();
    if(data.api_key){
        alert(`Application submitted! Your API Key: ${data.api_key}`);
        document.getElementById("full_name").value="";
        document.getElementById("email").value="";
        document.getElementById("phone").value="";
        document.getElementById("address").value="";
        document.getElementById("apiKeyInfo").innerText=`Your API Key: ${data.api_key} (keep it safe!)`;
    } else alert(data.error);
}

async function updatePriceFunc(){
    const id=document.getElementById("updateId").value;
    const price=parseFloat(document.getElementById("updatePrice").value);
    const apiKey=document.getElementById("apiKey").value;
    const res = await fetch("/update-price",{
        method:"PUT",
        headers:{"Content-Type":"application/json","X-API-KEY":apiKey},
        body:JSON.stringify({id,price})
    });
    const data = await res.json();
    alert(data.message || data.error);
    document.getElementById("updateId").value="";
    document.getElementById("updatePrice").value="";
    document.getElementById("apiKey").value="";
    loadPrices();
}

// ---------------------------
// Load Prices
// ---------------------------
async function loadPrices(){
    const res = await fetch("/prices");
    const data = await res.json();
    const list = document.getElementById("prices");
    list.innerHTML="";
    let totalPrice=0, count=0;
    data.forEach(p=>{
        const status=p.verified?'<span class="badge verified">Verified</span>':'<span class="badge pending">Pending</span>';
        list.innerHTML+=`<li>
            <div style="font-weight:bold; font-size:1.1em;">${p.station}</div>
            <div style="color:#aaa;">${p.location}</div>
            <div style="font-size:1.2em; color:#ffb570;">‚Ç¶${p.price}</div>
            <div style="font-size:0.8em; color:#666;">${status}</div>
        </li>`;
        if(p.verified){ totalPrice+=parseFloat(p.price); count++; }
    });
    const avgPrice = count? (totalPrice/count).toFixed(2) : "--";
    document.getElementById("priceSnapshot").innerText = `Lagos Avg: ‚Ç¶${avgPrice}`;
}

// ---------------------------
// Admin Login
// ---------------------------
async function adminLogin(){
    const key = prompt("Enter Admin Secret Key:");
    if(!key) return;
    const res = await fetch("/admin-login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({key}),
        credentials: "same-origin"
    });
    const data = await res.json();
    if(data.message){
        alert(data.message);
        document.getElementById("adminLoginBtn").style.display="none";
        document.getElementById("adminLogoutBtn").style.display="inline-block";
        window.location.href="/admin";
    } else alert(data.error);
}

function adminLogout(){ fetch("/admin-logout").then(()=>window.location.reload()); }

loadPrices();
</script>

</body>
</html>
