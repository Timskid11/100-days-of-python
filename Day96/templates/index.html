<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>⛽ CrudeWatch – Community Fuel Prices</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
    font-family:'Source Sans Pro',sans-serif;
    background:#121212;
    color:#eee;
    margin:0;
    padding:0;
}
h1 {
    font-family:'Playfair Display',serif;
    color:#ff4e00;
    font-size:3em;
    text-align:center;
    margin:30px 0 10px;
}
h2 {
    color:#ffb570;
    margin-top:30px;
    margin-bottom:15px;
    font-size:1.8em;
    border-bottom:2px solid #ff4e00;
    padding-bottom:5px;
}
.container { width:90%; max-width:900px; margin:0 auto; padding:20px;}
section { margin-bottom:40px; }
input, button {
    padding:12px 15px;
    margin:5px 0;
    border-radius:8px;
    border:none;
    font-size:1em;
}
input { width:100%; background:#222; color:#eee; }
button {
    background:#ff4e00;
    color:#fff;
    cursor:pointer;
    transition:0.3s;
}
button:hover { background:#ff7044; }
.price-card {
    background:linear-gradient(145deg, rgba(255,78,0,0.2), rgba(255,78,0,0.05));
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
    font-size:1.3em;
    text-align:center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    position: sticky;
    top:10px;
}
ul { list-style:none; padding:0; max-height:400px; overflow-y:auto; }
li {
    background:rgba(255,255,255,0.05);
    padding:12px 15px;
    margin:8px 0;
    border-radius:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    transition:0.2s;
}
li:hover { background:rgba(255,78,0,0.1); }
.badge { padding:4px 8px; border-radius:5px; font-weight:bold; margin-left:5px; }
.pending { background:yellow; color:#000; }
.verified { background:green; color:#fff; }
.admin-btn {
    margin-top:10px;
    background:#444;
    color:#fff;
    padding:10px 16px;
    border-radius:8px;
}
.admin-btn:hover { background:#666; }
form { margin-bottom:20px; }
</style>
</head>
<body>

<div class="container">
<h1>⛽ CrudeWatch – Community Fuel Prices</h1>

<!-- Quick Snapshot -->
<section>
<h2>Average Fuel Price Snapshot</h2>
<div class="price-card" id="priceSnapshot">Loading...</div>
</section>

<!-- Submit Fuel Price -->
<section>
<h2>Submit Fuel Price (Public)</h2>
<form onsubmit="submitPrice(); return false;">
<input id="station" placeholder="Station Name" required>
<input id="location" placeholder="Location" required>
<input id="price" type="number" placeholder="Price (₦)" required>
<button type="submit">Submit</button>
</form>
</section>

<!-- Apply for Trusted Access -->
<section>
<h2>Apply for Trusted Access</h2>
<form onsubmit="applyForTrust(); return false;">
<input id="full_name" placeholder="Full Name" required>
<input id="email" placeholder="Email" required>
<input id="phone" placeholder="Phone Number" required>
<input id="address" placeholder="Address" required>
<button type="submit">Apply</button>
<p id="apiKeyInfo" style="margin-top:10px;"></p>
</form>
</section>

<!-- Update Price (Trusted Users) -->
<section>
<h2>Update Price (Trusted Users Only)</h2>
<form onsubmit="updatePriceFunc(); return false;">
<input id="updateId" placeholder="Price ID to update" required>
<input id="updatePrice" type="number" placeholder="New Price" required>
<input id="apiKey" placeholder="Your API Key" required>
<button type="submit">Update Price</button>
</form>
</section>

<!-- Admin Access -->
<section>
<h2>Admin Access</h2>
<button id="adminLoginBtn" class="admin-btn" onclick="adminLogin()">Login as Admin</button>
<button id="adminLogoutBtn" class="admin-btn" onclick="adminLogout()" style="display:none;">Logout</button>
</section>

<!-- Latest Prices -->
<section>
<h2>Latest Prices</h2>
<ul id="prices"></ul>
</section>
</div>

<script>
// ---------------------------
// Public Functions
// ---------------------------
async function submitPrice(){
    const station=document.getElementById("station").value;
    const location=document.getElementById("location").value;
    const price=parseFloat(document.getElementById("price").value);
    const res = await fetch("/submit-price",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({station,location,price})
    });
    const data = await res.json();
    if(data.message){
        alert(data.message);
        document.getElementById("station").value="";
        document.getElementById("location").value="";
        document.getElementById("price").value="";
        loadPrices();
    } else alert(data.error);
}

async function applyForTrust(){
    const full_name=document.getElementById("full_name").value;
    const email=document.getElementById("email").value;
    const phone=document.getElementById("phone").value;
    const address=document.getElementById("address").value;
    const res = await fetch("/apply",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({full_name,email,phone,address})
    });
    const data = await res.json();
    if(data.api_key){
        alert(`Application submitted! Your API Key: ${data.api_key}`);
        document.getElementById("full_name").value="";
        document.getElementById("email").value="";
        document.getElementById("phone").value="";
        document.getElementById("address").value="";
        document.getElementById("apiKeyInfo").innerText=`Your API Key: ${data.api_key} (keep it safe!)`;
    } else alert(data.error);
}

async function updatePriceFunc(){
    const id=document.getElementById("updateId").value;
    const price=parseFloat(document.getElementById("updatePrice").value);
    const apiKey=document.getElementById("apiKey").value;
    const res = await fetch("/update-price",{
        method:"PUT",
        headers:{"Content-Type":"application/json","X-API-KEY":apiKey},
        body:JSON.stringify({id,price})
    });
    const data = await res.json();
    alert(data.message || data.error);
    document.getElementById("updateId").value="";
    document.getElementById("updatePrice").value="";
    document.getElementById("apiKey").value="";
    loadPrices();
}

// ---------------------------
// Load Prices
// ---------------------------
async function loadPrices(){
    const res = await fetch("/prices");
    const data = await res.json();
    const list = document.getElementById("prices");
    list.innerHTML="";
    let totalPrice=0, count=0;
    data.forEach(p=>{
        const status=p.verified?'<span class="badge verified">Verified</span>':'<span class="badge pending">Pending</span>';
        list.innerHTML+=`<li>ID ${p.id} – <b>${p.station}</b> (${p.location}) – ₦${p.price} ${status} | ${p.updated_at}</li>`;
        if(p.verified){ totalPrice+=parseFloat(p.price); count++; }
    });
    const avgPrice = count? (totalPrice/count).toFixed(2) : "No verified prices yet";
    document.getElementById("priceSnapshot").innerText = `Average Verified Price in Lagos: ₦${avgPrice}`;
}

// ---------------------------
// Admin Login (FIXED for session)
// ---------------------------
async function adminLogin(){
    const key = prompt("Enter Admin Secret Key:");
    if(!key) return;
    const res = await fetch("/admin-login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({key}),
        credentials: "same-origin"   // <<< FIX added so session works
    });
    const data = await res.json();
    if(data.message){
        alert(data.message);
        document.getElementById("adminLoginBtn").style.display="none";
        document.getElementById("adminLogoutBtn").style.display="inline-block";
        window.location.href="/admin";
    } else alert(data.error);
}

function adminLogout(){ fetch("/admin-logout").then(()=>window.location.reload()); }

// Initial load
loadPrices();
</script>

</body>
</html>
