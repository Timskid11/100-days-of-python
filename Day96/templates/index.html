<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>‚õΩ CrudeWatch ‚Äì Fuel Prices</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
<style>
/* Base Styles */
body {
    font-family:'Source Sans Pro',sans-serif;
    background:#121212;
    color:#eee;
    margin:0;
    padding:0;
    line-height: 1.6;
}
.container { 
    width:90%; 
    max-width:600px; /* Narrower container for a cleaner "app" feel */
    margin:0 auto; 
    padding:20px;
}

/* Headers */
h1 {
    font-family:'Playfair Display',serif;
    color:#ff4e00;
    font-size:2.2em;
    text-align:center;
    margin:20px 0 30px;
}
h2 {
    color:#fff;
    font-size:1.2em;
    margin-bottom:15px;
    border-left: 4px solid #ff4e00;
    padding-left: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}
section { margin-bottom:50px; }

/* CLEAN PRICE LIST STYLES (The Important Part) */
ul { list-style:none; padding:0; }

.price-item {
    background: #1e1e1e;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    border-left: 5px solid #333; /* Default border */
    transition: transform 0.2s;
}
.price-item:hover { transform: translateY(-2px); }

/* Status Color Coding */
.status-verified { border-left-color: #00c853; }
.status-pending { border-left-color: #ffd700; }

.station-info { display: flex; flex-direction: column; }
.station-name { 
    font-size: 1.1em; 
    font-weight: 700; 
    color: #fff; 
}
.station-loc { 
    font-size: 0.85em; 
    color: #888; 
    margin-top: 4px; 
}

.price-info { text-align: right; }
.price-val { 
    font-size: 1.4em; 
    font-weight: 700; 
    color: #ff4e00; 
}
.price-badge { 
    font-size: 0.7em; 
    text-transform: uppercase; 
    letter-spacing: 1px;
    font-weight: bold;
    opacity: 0.8;
}
.text-green { color: #00c853; }
.text-yellow { color: #ffd700; }


/* Form Elements */
input, button {
    padding:14px;
    margin:8px 0;
    border-radius:8px;
    border:none;
    font-size:1rem;
    width: 100%;
    box-sizing: border-box;
    background:#222; 
    color:#eee; 
    border: 1px solid #333;
}
input:focus { outline: 2px solid #ff4e00; background: #2a2a2a; }

button {
    background:#ff4e00;
    color:#fff;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor:pointer;
}
button:active { transform: scale(0.98); }

/* Admin Button */
.admin-btn { background:#333; color: #888; margin-top: 20px; font-size: 0.8em;}
</style>
</head>
<body>

<div class="container">
    <h1>‚õΩ CrudeWatch</h1>

    <section>
        <div style="text-align: center; margin-bottom: 20px; color: #888; font-size: 0.9em;" id="priceSnapshot">
            Loading average...
        </div>
        <ul id="prices"></ul>
    </section>

    <section>
        <h2>Report Price üìù</h2>
        <form onsubmit="submitPrice(); return false;">
            <input id="station" placeholder="Station Name (e.g. NNPC)" required>
            <input id="location" placeholder="Location (e.g. Ikeja Underbridge)" required>
            <input id="price" type="number" placeholder="Price per Litre (‚Ç¶)" required>
            <button type="submit">Submit Report</button>
        </form>
    </section>

    <section style="border-top: 1px solid #333; padding-top: 20px;">
        <details>
            <summary style="color: #666; cursor: pointer;">Advanced / Admin Options</summary>
            
            <div style="margin-top: 20px;">
                <h3 style="color:#aaa; font-size:1em;">Get Verified Access</h3>
                <form onsubmit="applyForTrust(); return false;">
                    <input id="full_name" placeholder="Full Name" required>
                    <input id="email" placeholder="Email" required>
                    <input id="phone" placeholder="Phone" required>
                    <input id="address" placeholder="Address" required>
                    <button type="submit" style="background:#444;">Apply</button>
                    <p id="apiKeyInfo" style="color:#ff4e00; font-size:0.9em;"></p>
                </form>

                <h3 style="color:#aaa; font-size:1em; margin-top:20px;">Update Existing Price</h3>
                <form onsubmit="updatePriceFunc(); return false;">
                    <input id="updateId" placeholder="Price ID" required>
                    <input id="updatePrice" type="number" placeholder="New Price" required>
                    <input id="apiKey" placeholder="API Key" required>
                    <button type="submit" style="background:#444;">Update</button>
                </form>

                <button id="adminLoginBtn" class="admin-btn" onclick="adminLogin()">Admin Login</button>
                <button id="adminLogoutBtn" class="admin-btn" onclick="adminLogout()" style="display:none;">Admin Logout</button>
            </div>
        </details>
    </section>
</div>

<script>
// ---------------------------
// Logic
// ---------------------------

async function loadPrices(){
    const res = await fetch("/prices");
    const data = await res.json();
    const list = document.getElementById("prices");
    list.innerHTML="";
    
    let totalPrice=0, count=0;

    data.forEach(p => {
        // Clean Logic for Styling
        const isVerified = p.verified === 1;
        const statusClass = isVerified ? "status-verified" : "status-pending";
        const badgeText = isVerified ? "Verified" : "Pending";
        const badgeColor = isVerified ? "text-green" : "text-yellow";

        list.innerHTML += `
        <li class="price-item ${statusClass}">
            <div class="station-info">
                <span class="station-name">${p.station}</span>
                <span class="station-loc">${p.location}</span>
                </div>
            <div class="price-info">
                <div class="price-val">‚Ç¶${p.price}</div>
                <div class="price-badge ${badgeColor}">${badgeText}</div>
            </div>
        </li>
        `;

        if(isVerified){ totalPrice+=parseFloat(p.price); count++; }
    });

    const avgPrice = count? (totalPrice/count).toFixed(0) : "--";
    document.getElementById("priceSnapshot").innerText = `Lagos Average: ‚Ç¶${avgPrice} / Litre`;
}

// ---------------------------
// Standard Form Functions (Same as before)
// ---------------------------
async function submitPrice(){
    const station=document.getElementById("station").value;
    const location=document.getElementById("location").value;
    const price=parseFloat(document.getElementById("price").value);
    
    // Simple Validation
    if(price < 500 || price > 2000) {
        if(!confirm("That price seems unusual. Are you sure?")) return;
    }

    const res = await fetch("/submit-price",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({station,location,price})
    });
    const data = await res.json();
    alert(data.message || data.error);
    if(data.message) {
        document.getElementById("station").value="";
        document.getElementById("location").value="";
        document.getElementById("price").value="";
        loadPrices();
    }
}

async function applyForTrust(){
    const full_name=document.getElementById("full_name").value;
    const email=document.getElementById("email").value;
    const phone=document.getElementById("phone").value;
    const address=document.getElementById("address").value;
    const res = await fetch("/apply",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({full_name,email,phone,address})
    });
    const data = await res.json();
    if(data.api_key){
        alert("Application Sent!");
        document.getElementById("apiKeyInfo").innerText=`KEY: ${data.api_key}`;
    } else alert(data.error);
}

async function updatePriceFunc(){
    const id=document.getElementById("updateId").value;
    const price=parseFloat(document.getElementById("updatePrice").value);
    const apiKey=document.getElementById("apiKey").value;
    const res = await fetch("/update-price",{
        method:"PUT",
        headers:{"Content-Type":"application/json","X-API-KEY":apiKey},
        body:JSON.stringify({id,price})
    });
    const data = await res.json();
    alert(data.message || data.error);
    loadPrices();
}

async function adminLogin(){
    const key = prompt("Admin Key:");
    if(!key) return;
    const res = await fetch("/admin-login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({key}),
        credentials: "same-origin"
    });
    const data = await res.json();
    if(data.message) window.location.href="/admin";
    else alert("Wrong Key");
}

function adminLogout(){ fetch("/admin-logout").then(()=>window.location.reload()); }

// Load on start
loadPrices();
</script>

</body>
</html>
